const TEXT = {
  appTitle: "Nomangho \ud50c\ub808\uc774\ub9ac\uc2a4\ud2b8 \ub0b4\ubcf4\ub0b4\uae30",
  sectionTrack: "\ud604\uc7ac \uace1 \uc815\ubcf4",
  sectionAdded: "\uc790\ub3d9 \ucd94\uac00 \ub0b4\uc5ed",
  sectionPlaylist: "\ud50c\ub808\uc774\ub9ac\uc2a4\ud2b8",
  sectionManual: "\uc218\ub3d9 \ucd94\uac00",
  manualToggleLabel: "\uc218\ub3d9 \ucd94\uac00 \ud328\ub110 \uc804\ud658",
  manualVideoPlaceholder: "YouTube \uc8fc\uc18c\ub97c \uc785\ub825\ud558\uc138\uc694",
  manualHelp: "\uc720\ud29c\ube0c \uc8fc\uc18c\ub9cc \uc785\ub825\ud558\uba74 \uc790\ub3d9\uc73c\ub85c \ud50c\ub808\uc774\ub9ac\uc2a4\ud2b8\uc5d0 \ub4f1\ub85d\ub429\ub2c8\ub2e4.",
  refresh: "\ub2e4\uc2dc \ubd88\ub7ec\uc624\uae30",
  playlistLinkLabel: "\ud50c\ub808\uc774\ub9ac\uc2a4\ud2b8 \uc5f4\uae30",
  trackLoading: "\uace1 \uc815\ubcf4\ub97c \ubd88\ub7ec\uc624\ub294 \uc911\uc785\ub2c8\ub2e4.",
  trackLatest: "\ucd5c\uadfc \uac10\uc9c0\ub41c \uace1",
  titleMissing: "\uc81c\ubaa9 \uc815\ubcf4\ub97c \ucc3e\uc9c0 \ubabb\ud588\uc5b4\uc694.",
  artistPrefix: "\uc544\ud2f0\uc2a4\ud2b8: ",
  artistMissing: "\uc544\ud2f0\uc2a4\ud2b8 \uc815\ubcf4\ub97c \ucc3e\uc9c0 \ubabb\ud588\uc5b4\uc694.",
  addedEmpty: "\uc544\uc9c1 \ucd94\uac00\ub41c \uace1\uc774 \uc5c6\uc5b4\uc694.",
  titleUnknown: "\uc81c\ubaa9 \uc5c6\uc74c",
  addedPrefix: "\ucd94\uac00: ",
  playlistReady: "Nomangho \uc11c\ubc84\uac00 \ucd5c\uc2e0 \uace1\uc744 YouTube \ud50c\ub808\uc774\ub9ac\uc2a4\ud2b8\uc5d0 \ucd94\uac00\ud588\uc2b5\ub2c8\ub2e4.",
  playlistPending: "YouTube \ud50c\ub808\uc774\ub9ac\uc2a4\ud2b8 \ub9c1\ud06c\uac00 \uc900\ube44\ub418\uba74 \uc5ec\uae30\uc5d0 \ud45c\uc2dc\ub429\ub2c8\ub2e4.",
  defaultNewTrack: "\uc0c8 \uace1",
  manualTrack: "\uc785\ub825\ud558\uc2e0 \uace1",
  targetTrack: "\ud574\ub2f9 \uace1",
  playlistAddedSuffix: "\uc744(\ub97c) \ud50c\ub808\uc774\ub9ac\uc2a4\ud2b8\uc5d0 \ucd94\uac00\ud588\uc2b5\ub2c8\ub2e4.",
  playlistRegisteredSuffix: "\uc744(\ub97c) \ud50c\ub808\uc774\ub9ac\uc2a4\ud2b8\uc5d0 \ub4f1\ub85d\ud588\uc2b5\ub2c8\ub2e4.",
  alreadySkippedSuffix: "\uc740 \uc774\ubbf8 \ucd94\uac00\ub418\uc5b4 \uac74\ub108\ub6f0\uc5c8\uc2b5\ub2c8\ub2e4.",
  searchMissing: "\uac80\uc0c9 \uacb0\uacfc\ub97c \ucc3e\uc9c0 \ubabb\ud588\uc5b4\uc694. \uc81c\ubaa9/\uc544\ud2f0\uc2a4\ud2b8 \uc815\ubcf4\ub97c \ud655\uc778\ud574\uc8fc\uc138\uc694.",
  matchMissing: "검색으로 동일한 곡을 찾지 못했어요.",
  infoMissing: "\uace1 \uc815\ubcf4\uac00 \ubd80\uc871\ud574\uc11c \uc790\ub3d9 \ucd94\uac00\ub97c \uac74\ub108\ub6f0\uc5c8\uc2b5\ub2c8\ub2e4.",
  videoMissing: "\uc601\uc0c1 \uc815\ubcf4\ub97c \ucc3e\uc9c0 \ubabb\ud574 \uc790\ub3d9 \ucd94\uac00\ub97c \uac74\ub108\ub6f0\uc5c8\uc2b5\ub2c8\ub2e4.",
  invalidResult: "\uac80\uc0c9 \uacb0\uacfc\uac00 \uc62c\ubc14\ub978\uc9c0 \uc54a\uc544 \ucd94\uac00\ud558\uc9c0 \ubabb\ud588\uc5b4\uc694.",
  autoError: "\uc790\ub3d9 \ucd94\uac00 \uc911 \uc624\ub958\uac00 \ubc1c\uc0dd\ud588\uc5b4\uc694.",
  autoUpdated: "\uc790\ub3d9 \ucd94\uac00 \uc0c1\ud0dc\uac00 \uc5c5\ub370\uc774\ud2b8\ub418\uc5c8\uc2b5\ub2c8\ub2e4.",
  autoQueued: "\uc790\ub3d9 \ucd94\uac00\uac00 \ub300\uae30\uc5f4\uc5d0 \ub4f1\ub85d\ub418\uc5c8\uc2b5\ub2c8\ub2e4.",
  manualQueued: "\uc218\ub3d9 \ucd94\uac00 \uc694\uccad\uc774 \ub300\uae30\uc5f4\uc5d0 \ub4f1\ub85d\ub418\uc5c8\uc2b5\ub2c8\ub2e4.",
  manualSkipped: "\uc694\uccad\ud558\uc2e0 \uace1\uc740 \uc774\ubbf8 \ub4f1\ub85d\ub418\uc5b4 \uac74\ub108\ub6f0\uc5c8\uc2b5\ub2c8\ub2e4.",
  statusError: "\uc0c1\ud0dc \uc815\ubcf4\ub97c \ubd88\ub7ec\uc624\uc9c0 \ubabb\ud588\uc5b4\uc694.",
  urlPrompt: "\uc720\ud6a8\ud55c YouTube \uc8fc\uc18c\ub97c \uc785\ub825\ud574\uc8fc\uc138\uc694.",
  requestSuccess: "\uc694\uccad\ud55c \uace1\uc744 \ud50c\ub808\uc774\ub9ac\uc2a4\ud2b8\uc5d0 \uc804\ub2ec\ud588\uc2b5\ub2c8\ub2e4.",
  duplicate: "\uc774\ubbf8 \ucd94\uac00\ub41c \uace1\uc785\ub2c8\ub2e4.",
  addFailed: "\ucd94\uac00\ud558\uc9c0 \ubabb\ud588\uc5b4\uc694.",
  noResponse: "\uc751\ub2f5\uc744 \ubc1b\uc9c0 \ubabb\ud588\uc5b4\uc694.",
  adding: "\ucd94\uac00 \uc911...",
  add: "\ucd94\uac00\ud558\uae30",
  statusAdded: "\ucd94\uac00\ub428",
  statusQueued: "\ub300\uae30\uc911",
  statusSkipped: "\uac74\ub108\ub700",
  open: "\uc5f4\uae30",
  close: "\ub2eb\uae30",
};

const state = {
  track: null,
  addedTracks: [],
  playlistUrl: null,
  note: null,
};

const els = {
  appTitle: document.getElementById("appTitle"),
  trackHeading: document.getElementById("trackHeading"),
  addedHeading: document.getElementById("addedHeading"),
  playlistHeading: document.getElementById("playlistHeading"),
  manualHeading: document.getElementById("manualHeading"),
  manualHelp: document.getElementById("manualHelp"),
  trackLabel: document.getElementById("trackLabel"),
  trackTitle: document.getElementById("trackTitle"),
  trackArtist: document.getElementById("trackArtist"),
  addedList: document.getElementById("addedList"),
  playlistStatus: document.getElementById("playlistStatus"),
  playlistLink: document.getElementById("playlistLink"),
  message: document.getElementById("message"),
  refresh: document.getElementById("refresh"),
  manualCard: document.getElementById("manualCard"),
  manualBody: document.getElementById("manualBody"),
  manualToggle: document.getElementById("manualToggle"),
  manualForm: document.getElementById("manualForm"),
  manualUrl: document.getElementById("manualUrl"),
  manualSubmit: document.getElementById("manualSubmit"),
};

let isManualCollapsed = true;

function setMessage(kind, text) {
  if (!els.message) return;
  if (!text) {
    els.message.textContent = "";
    els.message.dataset.kind = "";
    els.message.classList.add("hidden");
    return;
  }
  els.message.textContent = text;
  els.message.dataset.kind = kind;
  els.message.classList.remove("hidden");
}

function applyStaticText() {
  if (els.appTitle) {
    els.appTitle.textContent = TEXT.appTitle;
    document.title = TEXT.appTitle;
  }
  if (els.trackHeading) {
    els.trackHeading.textContent = TEXT.sectionTrack;
  }
  if (els.addedHeading) {
    els.addedHeading.textContent = TEXT.sectionAdded;
  }
  if (els.playlistHeading) {
    els.playlistHeading.textContent = TEXT.sectionPlaylist;
  }
  if (els.manualHeading) {
    els.manualHeading.textContent = TEXT.sectionManual;
  }
  if (els.manualHelp) {
    els.manualHelp.textContent = TEXT.manualHelp;
  }
  if (els.manualUrl) {
    els.manualUrl.placeholder = TEXT.manualVideoPlaceholder;
  }
  if (els.manualSubmit) {
    els.manualSubmit.textContent = TEXT.add;
  }
  if (els.manualToggle) {
    els.manualToggle.setAttribute("aria-label", TEXT.manualToggleLabel);
    els.manualToggle.setAttribute("aria-controls", "manualBody");
  }
  if (els.playlistLink) {
    els.playlistLink.textContent = TEXT.playlistLinkLabel;
  }
  if (els.refresh) {
    els.refresh.textContent = TEXT.refresh;
  }
}

function formatDate(ts) {
  if (!ts) return "";
  const d = new Date(ts);
  const yy = String(d.getFullYear()).slice(-2);
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${yy}.${mm}.${dd}`;
}

function formatTime(ts) {
  if (!ts) return "";
  const d = new Date(ts);
  const hh = String(d.getHours()).padStart(2, "0");
  const min = String(d.getMinutes()).padStart(2, "0");
  return `${hh}:${min}`;
}

function getYoutubeThumbnail(videoId) {
  if (!videoId) return null;
  const trimmed = String(videoId).trim();
  if (!trimmed) return null;
  return `https://i.ytimg.com/vi/${encodeURIComponent(trimmed)}/hqdefault.jpg`;
}

function extractVideoId(value) {
  if (!value) return "";
  const str = String(value).trim();
  const urlMatch = str.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|shorts\/|v\/|vi\/))([A-Za-z0-9_-]{6,})/i);
  if (urlMatch && urlMatch[1]) {
    return urlMatch[1];
  }
  const paramMatch = str.match(/[?&]v=([A-Za-z0-9_-]{6,})/);
  if (paramMatch && paramMatch[1]) {
    return paramMatch[1];
  }
  if (/^[A-Za-z0-9_-]{6,}$/.test(str)) {
    return str;
  }
  return "";
}

function normalizeStatus(status) {
  return status ? String(status).toLowerCase() : "";
}

function getStatusLabel(status) {
  const normalized = normalizeStatus(status);
  if (normalized === "queued") return TEXT.statusQueued;
  if (normalized === "skipped") return TEXT.statusSkipped;
  if (normalized === "added") return TEXT.statusAdded;
  return "";
}

function renderTrack() {
  const track = state.track;
  if (!track) {
    els.trackLabel.textContent = TEXT.trackLoading;
    els.trackLabel.classList.add("muted");
    els.trackTitle.textContent = "";
    els.trackArtist.textContent = "";
    return;
  }

  const labelDate = formatDate(track.updatedAt);
  const roomLabel = track.roomTitle || track.roomId || "";
  if (labelDate || roomLabel) {
    const label = [labelDate, roomLabel].filter(Boolean).join(" - ");
    els.trackLabel.textContent = label || TEXT.trackLatest;
  } else {
    els.trackLabel.textContent = TEXT.trackLatest;
  }
  els.trackLabel.classList.remove("muted");

  els.trackTitle.textContent = track.title || TEXT.titleMissing;
  els.trackArtist.textContent = track.author ? TEXT.artistPrefix + track.author : TEXT.artistMissing;
}

function renderAddedTracks() {
  const container = els.addedList;
  if (!container) return;

  if (!state.addedTracks.length) {
    container.className = "added-empty";
    container.textContent = TEXT.addedEmpty;
    return;
  }

  container.className = "added-list";
  container.innerHTML = "";

  state.addedTracks.forEach((item) => {
    const row = document.createElement("div");
    row.className = "added-item";

    const thumbUrl = item.thumbnail || getYoutubeThumbnail(item.videoId);

    if (thumbUrl) {      const img = document.createElement("img");
      img.className = "added-thumb";
      img.src = thumbUrl;
      img.alt = "";
      row.appendChild(img);
    } else {
      const placeholder = document.createElement("div");
      placeholder.className = "added-thumb";
      row.appendChild(placeholder);
    }

    const info = document.createElement("div");
    info.className = "added-info";

    const title = document.createElement("p");
    title.className = "added-title";
    title.textContent = item.title || TEXT.titleUnknown;
    info.appendChild(title);

    if (item.channel) {
      const channel = document.createElement("p");
      channel.className = "added-channel";
      channel.textContent = item.channel;
      info.appendChild(channel);
    }

    const meta = document.createElement("p");
    meta.className = "added-meta";
    const statusLabel = getStatusLabel(item.status);
    if (statusLabel) {
      const badge = document.createElement("span");
      badge.className = "added-status added-status-" + normalizeStatus(item.status);
      badge.textContent = statusLabel;
      meta.appendChild(badge);
    }
    const datePart = formatDate(item.addedAt);
    const timePart = formatTime(item.addedAt);
    const combined = [datePart, timePart].filter(Boolean).join(" ");
    if (combined) {
      const metaText = document.createElement("span");
      metaText.textContent = TEXT.addedPrefix + combined;
      meta.appendChild(metaText);
    }
    info.appendChild(meta);

    row.appendChild(info);
    container.appendChild(row);
  });
}

function renderPlaylistLink(url) {
  if (els.playlistLink) {
    els.playlistLink.textContent = TEXT.playlistLinkLabel;
  }
  if (url) {
    els.playlistStatus.textContent = TEXT.playlistReady;
    els.playlistLink.href = url;
    els.playlistLink.classList.add("active");
    els.playlistLink.setAttribute("aria-disabled", "false");
  } else {
    els.playlistStatus.textContent = TEXT.playlistPending;
    els.playlistLink.href = "#";
    els.playlistLink.classList.remove("active");
    els.playlistLink.setAttribute("aria-disabled", "true");
  }
}

function applyNote(note) {
  if (!note) {
    setMessage("", "");
    return;
  }

  const title = note.title || "";
  switch (note.type) {
    case "auto-added":
      setMessage("success", `${title || TEXT.defaultNewTrack}${TEXT.playlistAddedSuffix}`);
      break;
    case "manual-added":
      setMessage("success", `${title || TEXT.manualTrack}${TEXT.playlistRegisteredSuffix}`);
      break;
    case "manual-queued":
      setMessage("info", TEXT.manualQueued);
      break;
    case "manual-skipped":
      setMessage("info", TEXT.manualSkipped);
      break;
    case "auto-queued":
      setMessage("info", TEXT.autoQueued);
      break;
    case "skipped-duplicate":
    case "manual-duplicate":
      setMessage("info", `${title || TEXT.targetTrack}${TEXT.alreadySkippedSuffix}`);
      break;
    case "no-results":
      setMessage("info", TEXT.searchMissing);
      break;
    case "skip-empty-query":
      setMessage("info", TEXT.infoMissing);
      break;
    case "skip-no-videoid":
      setMessage("info", TEXT.videoMissing);
      break;
    case "skip-no-metadata":
      setMessage("info", TEXT.infoMissing);
      break;
    case "skip-no-match":
      setMessage("info", TEXT.matchMissing);
      break;
    case "invalid-result":
      setMessage("error", TEXT.invalidResult);
      break;
    case "manual-error":
    case "error-add":
    case "error":
      setMessage("error", note.message || TEXT.autoError);
      break;
    default:
      setMessage("info", TEXT.autoUpdated);
      break;
  }
}

function requestStatus() {
  return new Promise((resolve) => {
    chrome.runtime.sendMessage({ type: "GET_STATUS" }, (response) => {
      const err = chrome.runtime.lastError;
      if (err) {
        setMessage("error", err.message);
        resolve(null);
        return;
      }
      if (!response?.ok) {
        setMessage("error", response?.error || TEXT.statusError);
        resolve(null);
        return;
      }
      resolve(response);
    });
  });
}

function applyStatus(status) {
  if (!status) {
    return;
  }
  state.track = status.track || null;
  state.addedTracks = Array.isArray(status.addedTracks) ? status.addedTracks : [];
  state.playlistUrl = status.playlistUrl || null;
  state.note = status.note || null;

  renderTrack();
  renderAddedTracks();
  renderPlaylistLink(state.playlistUrl);
  applyNote(state.note);
}

async function refreshState() {
  const status = await requestStatus();
  applyStatus(status);
}

function setManualCollapsed(collapsed) {
  isManualCollapsed = collapsed;
  if (els.manualCard) {
    els.manualCard.classList.toggle("collapsed", collapsed);
  }
  if (els.manualBody) {
    els.manualBody.setAttribute("aria-hidden", String(collapsed));
    els.manualBody.classList.toggle("expanded", !collapsed);
  }
  if (els.manualToggle) {
    els.manualToggle.setAttribute("aria-checked", String(!collapsed));
    els.manualToggle.classList.toggle("is-active", !collapsed);
  }
  if (!collapsed) {
    els.manualUrl?.focus();
  }
}

function toggleManualSection() {
  setManualCollapsed(!isManualCollapsed);
}

function setManualPending(pending) {
  if (!els.manualSubmit) return;
  els.manualSubmit.disabled = pending;
  els.manualSubmit.textContent = pending ? TEXT.adding : TEXT.add;
}

async function submitManualAdd(event) {
  event.preventDefault();
  if (!els.manualUrl) return;

  const rawUrl = els.manualUrl.value.trim();
  if (!rawUrl) {
    setMessage("error", TEXT.urlPrompt);
    els.manualUrl.focus();
    return;
  }

  const payload = {
    url: rawUrl,
    roomId: state.track?.roomId || "",
    roomTitle: state.track?.roomTitle || "",
  };

  setManualPending(true);
  chrome.runtime.sendMessage({ type: "ADD_MANUAL_TRACK", payload }, (response) => {
    const err = chrome.runtime.lastError;
    setManualPending(false);
    if (err) {
      setMessage("error", err.message);
      return;
    }
    if (!response) {
      setMessage("error", TEXT.noResponse);
      return;
    }
    if (response.ok) {
      const status = String(response.status || "added").toLowerCase();
      if (status === "queued") {
        setMessage("info", TEXT.manualQueued);
      } else if (status === "skipped") {
        setMessage("info", TEXT.manualSkipped);
      } else {
        setMessage("success", TEXT.requestSuccess);
      }
      els.manualForm?.reset();
      refreshState();
    } else {
      if (response.error === "duplicate") {
        setMessage("info", TEXT.duplicate);
      } else if (response.error === "missing_url" || response.error === "missing_videoId") {
        setMessage("error", TEXT.urlPrompt);
      } else {
        setMessage("error", response.error || TEXT.addFailed);
      }
    }
  });
}

chrome.storage.onChanged?.addListener((changes, area) => {
  if (area !== "local") return;
  if (Object.prototype.hasOwnProperty.call(changes, "lastTrack")) {
    state.track = changes.lastTrack?.newValue || null;
    renderTrack();
  }
  if (Object.prototype.hasOwnProperty.call(changes, "addedTracks")) {
    state.addedTracks = changes.addedTracks?.newValue || [];
    renderAddedTracks();
  }
  if (Object.prototype.hasOwnProperty.call(changes, "lastPlaylistUrl")) {
    state.playlistUrl = changes.lastPlaylistUrl?.newValue || null;
    renderPlaylistLink(state.playlistUrl);
  }
  if (Object.prototype.hasOwnProperty.call(changes, "lastAutoAddNote")) {
    state.note = changes.lastAutoAddNote?.newValue || null;
    applyNote(state.note);
  }
});

document.addEventListener("DOMContentLoaded", () => {
  applyStaticText();
  setManualCollapsed(true);
  renderTrack();
  renderAddedTracks();
  renderPlaylistLink(null);
  els.manualToggle?.addEventListener("click", toggleManualSection);
  els.refresh?.addEventListener("click", refreshState);
  els.manualForm?.addEventListener("submit", submitManualAdd);
  refreshState();
});
